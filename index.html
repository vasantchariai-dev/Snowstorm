<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>Snowstorm at Bjergvej</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  width: 100%; height: 100%;
  overflow: hidden;
  background: #1a1a2e;
  touch-action: none;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}
canvas {
  display: block;
  image-rendering: pixelated;
  image-rendering: crisp-edges;
}
#ui-overlay {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 10;
}
#score-display {
  position: absolute; top: 8px; left: 12px;
  font-family: monospace; font-size: 14px; color: #fff;
  text-shadow: 2px 2px 0 #000;
  line-height: 1.5;
}
#touch-controls {
  position: absolute; bottom: 0; left: 0; width: 100%; height: 30%;
  pointer-events: all; display: flex; z-index: 20;
}
.touch-zone {
  flex: 1; display: flex; align-items: center; justify-content: center;
  opacity: 0.12; font-size: 36px; color: #fff;
  border: 1px solid rgba(255,255,255,0.08);
}
.touch-zone:active { opacity: 0.25; }
#start-screen, #gameover-screen {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  background: rgba(10, 10, 30, 0.92); z-index: 30; pointer-events: all;
  font-family: monospace; color: #fff; text-align: center;
}
#start-screen h1 {
  font-size: 28px; margin-bottom: 6px;
  text-shadow: 3px 3px 0 #2d5f8a;
}
#start-screen .subtitle { font-size: 14px; color: #8ac; margin-bottom: 20px; }
#start-screen .instructions {
  font-size: 12px; color: #bbb; line-height: 1.8; margin-bottom: 20px; padding: 0 20px;
}
.play-btn {
  background: #4a9; color: #fff; border: none; padding: 16px 48px;
  font-family: monospace; font-size: 20px; cursor: pointer;
  border-radius: 4px; text-shadow: 1px 1px 0 #000;
  box-shadow: 0 4px 0 #387;
}
.play-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #387; }
#gameover-screen h2 { font-size: 24px; margin-bottom: 16px; color: #f66; }
#gameover-screen .final-score { font-size: 18px; margin-bottom: 8px; }
#gameover-screen .reason { font-size: 14px; color: #aaa; margin-bottom: 24px; }
.action-btn {
  position: absolute; width: 60px; height: 60px; border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.5); color: #fff;
  font-size: 22px; z-index: 25; pointer-events: all;
  display: none; align-items: center; justify-content: center;
  font-family: monospace;
}
.action-btn:active { transform: scale(0.92); }
#throw-btn {
  bottom: 32%; right: 16px;
  background: rgba(255, 160, 60, 0.7);
}
#fire-btn {
  bottom: 32%; right: 90px;
  background: rgba(255, 80, 30, 0.7);
}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="ui-overlay">
  <div id="score-display"></div>
</div>
<div id="touch-controls">
  <div class="touch-zone" id="btn-left">&#9664;</div>
  <div class="touch-zone" id="btn-duck">&#9660;</div>
  <div class="touch-zone" id="btn-jump">&#9650;</div>
  <div class="touch-zone" id="btn-right">&#9654;</div>
</div>
<button class="action-btn" id="throw-btn">&#127828;</button>
<button class="action-btn" id="fire-btn">&#128293;</button>

<div id="start-screen">
  <h1>SNOWSTORM</h1>
  <div class="subtitle">at Bjergvej</div>
  <div class="instructions">
    Sara must survive the blizzard!<br><br>
    &#9664; LEFT | &#9660; DUCK | &#9650; JUMP | RIGHT &#9654;<br><br>
    <b>JUMP</b> over snowdrifts &amp; cats<br>
    <b>DUCK</b> under high snowstorms<br>
    <b>FIREWOOD</b> - light fires to melt snow!<br>
    <b>BURGERS</b> - throw to feed Emily<br><br>
    Watch out for Effie &amp; Nora!
  </div>
  <button class="play-btn" id="start-btn">PLAY</button>
</div>

<div id="gameover-screen" style="display:none">
  <h2>GAME OVER</h2>
  <div class="final-score" id="final-score"></div>
  <div class="final-score" id="final-hi"></div>
  <div class="reason" id="death-reason"></div>
  <button class="play-btn" id="restart-btn">RETRY</button>
</div>

<script>
// ============================================================
// SNOWSTORM AT BJERGVEJ
// ============================================================

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

let W, H, SCALE, GROUND_Y;
function resize() {
  W = window.innerWidth;
  H = window.innerHeight;
  canvas.width = W;
  canvas.height = H;
  SCALE = Math.max(2, Math.round(Math.max(W, H) / 160));
  if (SCALE > 6) SCALE = 6;
  GROUND_Y = H - 60;
}
resize();
window.addEventListener('resize', resize);

function drawPixelSprite(x, y, pixels, scale) {
  const s = scale || SCALE;
  for (let r = 0; r < pixels.length; r++) {
    for (let c = 0; c < pixels[r].length; c++) {
      if (pixels[r][c]) {
        ctx.fillStyle = pixels[r][c];
        ctx.fillRect(Math.floor(x + c * s), Math.floor(y + r * s), s, s);
      }
    }
  }
}

// ---- SPRITES ----

function saraSprite(frame, ducking) {
  const _ = null;
  const h = '#5a3825', s = '#f5c6a0', e = '#222';
  const f1 = '#c0392b', f2 = '#2c3e50', p = '#34495e', b = '#2c2c2c', m = '#d9a88c';

  if (ducking) {
    // Compact ducking pose (12x10)
    return [
      [_,_,_,h,h,h,h,h,h,_,_,_],
      [_,_,h,s,s,s,s,s,s,h,_,_],
      [_,_,s,s,e,s,s,e,s,s,_,_],
      [_,_,_,s,s,m,s,s,_,_,_,_],
      [_,f1,f1,f1,f2,f1,f2,f1,f1,f1,_,_],
      [_,s,f1,f2,f1,f2,f1,f2,f1,s,_,_],
      [_,_,f1,f2,f1,f2,f1,f2,f1,_,_,_],
      [_,_,_,p,p,p,p,p,p,_,_,_],
      [_,_,b,b,p,p,p,p,b,b,_,_],
      [_,b,b,b,_,_,_,_,b,b,b,_],
    ];
  }

  const base = [
    [_,_,_,h,h,h,h,h,h,_,_,_],
    [_,_,h,h,h,h,h,h,h,h,_,_],
    [_,_,h,s,s,s,s,s,s,h,_,_],
    [_,_,s,s,e,s,s,e,s,s,_,_],
    [_,_,s,s,s,s,s,s,s,s,_,_],
    [_,_,_,s,s,m,s,s,_,_,_,_],
    [_,_,_,f1,f2,f1,f2,f1,_,_,_,_],
    [_,_,f1,f1,f2,f1,f2,f1,f1,_,_,_],
    [_,s,f1,f2,f1,f2,f1,f2,f1,s,_,_],
    [_,_,f1,f2,f1,f2,f1,f2,f1,_,_,_],
    [_,_,_,f1,f2,f1,f2,f1,_,_,_,_],
    [_,_,_,_,p,p,p,p,_,_,_,_],
    [_,_,_,_,p,p,p,p,_,_,_,_],
    [_,_,_,p,p,_,_,p,p,_,_,_],
    [_,_,_,b,b,_,_,b,b,_,_,_],
    [_,_,b,b,b,_,_,b,b,b,_,_],
  ];
  if (frame === 1) {
    base[13] = [_,_,p,p,_,_,_,_,p,p,_,_];
    base[14] = [_,b,b,b,_,_,_,_,b,b,_,_];
    base[15] = [_,b,b,_,_,_,_,_,_,b,b,_];
  } else if (frame === 2) {
    base[13] = [_,_,_,_,p,p,p,p,_,_,_,_];
    base[14] = [_,_,_,_,b,b,b,b,_,_,_,_];
    base[15] = [_,_,_,b,b,_,_,b,b,_,_,_];
  }
  return base;
}

function emilySprite(frame) {
  const _ = null;
  const h = '#6b3a2a', s = '#f5c6a0', e = '#222', m = '#d9a88c';
  const d = '#6a5acd', d2 = '#483d8b', p = '#34495e', b = '#2c2c2c';
  const base = [
    [_,_,_,_,h,h,h,h,h,h,_,_,_,_],
    [_,_,_,h,h,h,h,h,h,h,h,_,_,_],
    [_,_,h,h,h,h,h,h,h,h,h,h,_,_],
    [_,_,h,s,s,s,s,s,s,s,s,h,_,_],
    [_,_,h,s,e,s,s,s,e,s,s,h,_,_],
    [_,_,h,s,s,s,s,s,s,s,s,h,_,_],
    [_,_,h,_,s,s,m,s,s,_,_,h,_,_],
    [_,_,h,_,_,d,d2,d,_,_,_,h,_,_],
    [_,_,h,_,d,d,d2,d,d,_,_,h,_,_],
    [_,_,h,d,d,d2,d,d2,d,d,_,h,_,_],
    [_,s,h,d,d2,d,d2,d,d2,d,h,s,_,_],
    [_,_,h,d,d,d2,d,d2,d,d,h,_,_,_],
    [_,_,_,_,d,d2,d,d2,d,_,_,_,_,_],
    [_,_,_,_,_,p,p,p,p,_,_,_,_,_],
    [_,_,_,_,_,p,p,p,p,_,_,_,_,_],
    [_,_,_,_,_,p,p,p,p,_,_,_,_,_],
    [_,_,_,_,p,p,_,_,p,p,_,_,_,_],
    [_,_,_,_,p,p,_,_,p,p,_,_,_,_],
    [_,_,_,_,b,b,_,_,b,b,_,_,_,_],
    [_,_,_,b,b,b,_,_,b,b,b,_,_,_],
  ];
  if (Math.floor(frame / 15) % 2 === 0) {
    base[10] = [s,s,h,d,d2,d,d2,d,d2,d,h,s,s,_];
  }
  return base;
}

// Nora: big fluffy brown cat (16x12)
function noraSprite(frame) {
  const _ = null;
  const c = '#8B5E3C', c2 = '#A0724B', f = '#C4956A';
  const e = '#4a4', n = '#faa', w = '#fff';
  // Nora sits and lounges - she's big and in the way
  const base = [
    [_,c,c,_,_,_,_,_,_,_,_,_,_,c,c,_],
    [c,c2,c,c,_,_,_,_,_,_,_,_,c,c2,c,_],
    [c,f,c2,c,c,c,c,c,c,c,c,c,c,f,c,_],
    [c,f,f,c2,c,c,c,c,c,c,c,c2,f,f,c,_],
    [c,c2,f,c2,c,c,c,c,c,c,c2,f,c2,c,c,_],
    [c,c,e,w,c,c,c,c,c,c,e,w,c,c,c,_],
    [c,c2,c,c,c,n,n,c,c,c,c,c,c,c2,c,_],
    [c,f,c2,c,c,c,c,c,c,c,c,c2,f,c,c,_],
    [_,c,f,c2,c,c,c,c,c,c,c2,f,c,_,_,_],
    [_,_,c,f,c,c,c,c,c,c,f,c,_,_,_,_],
    [_,_,c,_,c,c,_,_,c,c,_,c,_,_,_,_],
    [_,_,c,_,c,c,_,_,c,c,_,c,_,_,_,_],
  ];
  // Tail swish animation
  if (frame % 2 === 0) {
    base[8] = [_,c,f,c2,c,c,c,c,c,c,c2,f,c,c,c,c];
    base[9] = [_,_,c,f,c,c,c,c,c,c,f,c,_,_,c,c];
  }
  return base;
}

// Effie: ginger and white cat (14x10) - fast and darty
function effieSprite(frame) {
  const _ = null;
  const g = '#E87A2E', g2 = '#D46A1E', w = '#fff', ww = '#f0e8e0';
  const e = '#4c4', n = '#faa';
  const base = [
    [_,g,g,_,_,_,_,_,_,_,_,g,g,_],
    [g,g2,g,g,_,_,_,_,_,_,g,g2,g,_],
    [g,w,g2,g,g,g,g,g,g,g,g,w,g,_],
    [g,w,w,g,g,g,g,g,g,g,w,w,g,_],
    [g,w,e,ww,g,g,g,g,g,e,ww,w,g,_],
    [g,w,w,g,g,n,g,g,g,w,w,g,g,_],
    [g,g,w,w,g,g,g,g,w,w,g,g,g,_],
    [_,g,g,w,w,g,g,w,w,g,g,_,_,_],
    [_,_,g,_,g,g,_,g,g,_,g,_,_,_],
    [_,_,g,_,g,g,_,g,g,_,g,_,_,_],
  ];
  // Running legs animation
  if (frame % 2 === 0) {
    base[8] = [_,_,_,g,g,_,_,_,g,g,_,_,_,_];
    base[9] = [_,_,g,_,_,_,_,g,_,_,_,_,_,_];
  }
  return base;
}

function snowstormSprite() {
  const w = '#e8eaf0', w2 = '#c8d0e0', b = '#a0b0d0', _ = null;
  return [
    [_,w,w,w2,w2,w,w,_],
    [w,w2,w,b,w,w2,w,w],
    [w,w,b,w2,b,w,w2,w],
    [w2,b,w2,w,w2,b,w,w2],
    [w,w2,w,b,w,w2,b,w],
    [w2,w,b,w2,b,w,w2,w],
    [w,w2,w,w,w2,w,w,w2],
    [_,w,w2,w,w,w2,w,_],
  ];
}

function snowdriftSprite() {
  const w = '#dde0f0', w2 = '#c5cae0', b = '#b0b8d0', _ = null;
  return [
    [_,_,_,_,w,w,_,_,_,_],
    [_,_,_,w,w2,w,w,_,_,_],
    [_,_,w,w2,b,w2,w,w,_,_],
    [_,w,w2,b,w2,b,w2,w,w,_],
    [w,w2,b,w2,w,w2,b,w2,w,w],
    [w,w,w2,w,w,w,w2,w,w,w],
  ];
}

function firewoodSprite() {
  const br = '#8B4513', db = '#654321', o = '#D2691E', _ = null;
  return [
    [_,_,br,br,br,br,_,_],
    [_,br,db,o,db,o,br,_],
    [br,o,db,br,o,db,o,br],
    [br,db,o,db,br,o,db,br],
    [_,br,db,o,db,o,br,_],
    [_,_,br,br,br,br,_,_],
  ];
}

function burgerSprite() {
  const bn = '#D2A050', mt = '#8B2500', lt = '#4CAF50', ch = '#FFD700', tm = '#ff4444', _ = null;
  return [
    [_,_,bn,bn,bn,bn,_,_],
    [_,bn,bn,bn,bn,bn,bn,_],
    [lt,lt,lt,lt,lt,lt,lt,lt],
    [mt,mt,ch,mt,mt,ch,mt,mt],
    [mt,ch,mt,mt,ch,mt,mt,mt],
    [tm,tm,tm,tm,tm,tm,tm,tm],
    [_,bn,bn,bn,bn,bn,bn,_],
  ];
}

// Campfire sprite (8x8)
function campfireSprite(frame) {
  const _ = null;
  const br = '#8B4513', db = '#654321';
  const f1 = '#ff4400', f2 = '#ff8800', f3 = '#ffcc00', f4 = '#ff6600';
  // Animate flames
  if (frame % 2 === 0) {
    return [
      [_,_,_,_,f3,_,_,_],
      [_,_,_,f3,f2,f3,_,_],
      [_,_,f2,f1,f3,f2,_,_],
      [_,f2,f1,f4,f1,f3,f2,_],
      [_,f1,f4,f2,f4,f1,f4,_],
      [f1,f4,f1,f1,f1,f4,f1,_],
      [_,db,br,br,br,br,db,_],
      [_,br,db,br,db,br,br,_],
    ];
  } else {
    return [
      [_,_,_,f3,_,_,_,_],
      [_,_,f3,f2,f3,_,_,_],
      [_,_,f2,f3,f1,f2,_,_],
      [_,f2,f3,f1,f4,f2,f2,_],
      [_,f4,f1,f4,f2,f1,f4,_],
      [f4,f1,f4,f1,f4,f1,f1,_],
      [_,db,br,br,br,br,db,_],
      [_,br,db,br,db,br,br,_],
    ];
  }
}

// ---- GAME STATE ----
const GRAVITY = 0.38;
const JUMP_FORCE = -11.5;
const MOVE_SPEED = 3.5;
const SCROLL_SPEED_BASE = 0.9;

let game = {};
let highScore = parseInt(localStorage.getItem('snowstorm_hi2') || '0');

function initGame() {
  const saraH = 16 * SCALE;
  game = {
    running: true,
    score: 0,
    firewood: 0,
    burgers: 0,
    scrollSpeed: SCROLL_SPEED_BASE,
    scrollX: 0,
    frameCount: 0,
    deathReason: '',

    sara: {
      x: W * 0.25,
      y: GROUND_Y - saraH,
      vy: 0, vx: 0,
      onGround: true,
      width: 12 * SCALE,
      height: saraH,
      standingHeight: saraH,
      duckHeight: 10 * SCALE,
      ducking: false,
      frame: 0, frameTimer: 0,
      facing: 1,
    },

    platforms: [],
    snowstorms: [],
    snowdrifts: [],
    firewoods: [],
    burgerItems: [],
    cats: [],
    thrownBurgers: [],
    campfires: [],
    particles: [],
    snowflakes: [],

    // Emily: persistent character on the right side
    emily: {
      x: W - 14 * SCALE - 15,
      y: GROUND_Y - 20 * SCALE,
      baseWidth: 14 * SCALE,
      baseHeight: 20 * SCALE,
      width: 14 * SCALE,
      height: 20 * SCALE,
      scale: 1.0,         // grows when fed
      timesFed: 0,
      hungry: false,
      hungryTimer: 180,   // first HUNGRY comes quickly
      hungryCooldown: 0,  // how long she stays hungry
      frame: 0,
    },

    spawnTimer: 0,
    catTimer: 120,     // First cat appears early!
    difficultyTimer: 0,

    input: { left: false, right: false, jump: false, duck: false },
  };

  for (let i = 0; i < 80; i++) {
    game.snowflakes.push({
      x: Math.random() * W, y: Math.random() * H,
      size: Math.random() * 3 + 1,
      speed: Math.random() * 1.5 + 0.5,
      drift: Math.random() * 0.8 - 0.4,
    });
  }

  generateInitialPlatforms();
  // Spawn first cat immediately at a visible distance
  spawnCat(W * 0.8);
}

function generateInitialPlatforms() {
  let x = W * 0.6;
  for (let i = 0; i < 6; i++) {
    x += Math.random() * 140 + 100;
    const pw = Math.random() * 80 + 60;
    const py = GROUND_Y - Math.random() * 80 - 50;
    game.platforms.push({ x, y: py, w: pw, h: 8 * SCALE });
    if (Math.random() > 0.4) {
      const itemY = py - 7 * SCALE;
      if (Math.random() > 0.5) {
        game.firewoods.push({ x: x + pw/2 - 4*SCALE, y: itemY, width: 8*SCALE, height: 6*SCALE });
      } else {
        game.burgerItems.push({ x: x + pw/2 - 4*SCALE, y: itemY, width: 8*SCALE, height: 7*SCALE });
      }
    }
  }
}

function spawnCat(xPos) {
  const isNora = Math.random() > 0.5;
  const catW = isNora ? 16 * SCALE : 14 * SCALE;
  const catH = isNora ? 12 * SCALE : 10 * SCALE;
  game.cats.push({
    x: xPos,
    y: GROUND_Y - catH,
    width: catW, height: catH,
    // Nora is slow and sits; Effie is fast and darty
    speed: isNora ? game.scrollSpeed + 0.2 : game.scrollSpeed + 0.8 + Math.random() * 0.6,
    name: isNora ? 'Nora' : 'Effie',
    jumpTimer: isNora ? 200 : 40 + Math.random() * 40,
    vy: 0,
    baseY: GROUND_Y - catH,
    frame: 0,
    // Effie darts back and forth
    dartTimer: isNora ? 999 : 60 + Math.random() * 40,
    dartDir: 1,
  });
}

// ---- SPAWNING ----
function spawnEntities() {
  game.spawnTimer++;
  const diff = Math.min(game.score / 800, 2.5);

  // Platforms with collectibles
  if (game.spawnTimer % Math.max(50, 80 - diff * 6) === 0) {
    const py = GROUND_Y - Math.random() * 90 - 45;
    const pw = Math.random() * 80 + 55;
    game.platforms.push({ x: W + 40, y: py, w: pw, h: 8 * SCALE });
    if (Math.random() > 0.3) {
      const itemY = py - 7 * SCALE;
      if (Math.random() > 0.5) {
        game.firewoods.push({ x: W+40+pw/2-4*SCALE, y: itemY, width: 8*SCALE, height: 6*SCALE });
      } else {
        game.burgerItems.push({ x: W+40+pw/2-4*SCALE, y: itemY, width: 8*SCALE, height: 7*SCALE });
      }
    }
  }

  // Snowdrifts on ground - JUMP over
  if (game.spawnTimer % Math.max(70, 110 - diff * 8) === 0) {
    game.snowdrifts.push({
      x: W + 40,
      y: GROUND_Y - 6 * SCALE,
      width: 10 * SCALE, height: 6 * SCALE,
      speed: game.scrollSpeed,
    });
  }

  // Snowstorms - TWO types: LOW (jump over) and HIGH (duck under)
  if (game.spawnTimer % Math.max(90, 130 - diff * 10) === 0) {
    const isHigh = Math.random() > 0.45;
    const sy = isHigh
      ? GROUND_Y - 14 * SCALE - Math.random() * 20   // head height - DUCK
      : GROUND_Y - 6 * SCALE - Math.random() * 10;    // ground level - JUMP
    game.snowstorms.push({
      x: W + 40, y: sy,
      width: 8 * SCALE * (Math.random() > 0.6 ? 2 : 1),
      height: 8 * SCALE,
      speed: game.scrollSpeed + 0.2 + Math.random() * 0.5,
      isHigh: isHigh,
    });
  }

  // Firewood on ground
  if (game.spawnTimer % 100 === 0 && Math.random() > 0.3) {
    game.firewoods.push({
      x: W + 40, y: GROUND_Y - 6*SCALE,
      width: 8*SCALE, height: 6*SCALE,
    });
  }

  // Burgers on ground
  if (game.spawnTimer % 160 === 0 && Math.random() > 0.4) {
    game.burgerItems.push({
      x: W + 40, y: GROUND_Y - 7*SCALE,
      width: 8*SCALE, height: 7*SCALE,
    });
  }

  // CATS - spawn frequently and guaranteed
  game.catTimer--;
  if (game.catTimer <= 0) {
    spawnCat(W + 40);
    // Next cat in 80-160 frames (roughly 1.5-3 seconds)
    game.catTimer = Math.max(60, 120 - diff * 10) + Math.random() * 60;
  }

  // Emily hunger cycle
  const em = game.emily;
  if (!em.hungry) {
    em.hungryTimer--;
    if (em.hungryTimer <= 0) {
      em.hungry = true;
      em.hungryCooldown = 300; // hungry for ~5 seconds
    }
  } else {
    em.hungryCooldown--;
    if (em.hungryCooldown <= 0) {
      em.hungry = false;
      em.hungryTimer = 200 + Math.random() * 150; // next hunger cycle
    }
  }
  em.frame++;
}

// ---- UPDATE ----
function update() {
  if (!game.running) return;

  game.frameCount++;
  game.difficultyTimer++;
  if (game.difficultyTimer % 900 === 0) {
    game.scrollSpeed = Math.min(SCROLL_SPEED_BASE + game.difficultyTimer / 2500, 2.5);
  }

  const sara = game.sara;
  const inp = game.input;

  // Duck mechanic
  if (inp.duck && sara.onGround) {
    if (!sara.ducking) {
      sara.ducking = true;
      sara.height = sara.duckHeight;
      sara.y = GROUND_Y - sara.duckHeight;
    }
  } else if (sara.ducking) {
    sara.ducking = false;
    sara.height = sara.standingHeight;
    sara.y = GROUND_Y - sara.standingHeight;
  }

  // Movement
  if (inp.left) { sara.vx = -MOVE_SPEED; sara.facing = -1; }
  else if (inp.right) { sara.vx = MOVE_SPEED; sara.facing = 1; }
  else { sara.vx *= 0.7; if (Math.abs(sara.vx) < 0.2) sara.vx = 0; }

  sara.x -= game.scrollSpeed * 0.4;
  sara.x += sara.vx;
  if (sara.x < 0) sara.x = 0;
  if (sara.x + sara.width > W) sara.x = W - sara.width;

  // Jump (not while ducking)
  if (inp.jump && sara.onGround && !sara.ducking) {
    sara.vy = JUMP_FORCE;
    sara.onGround = false;
    spawnParticles(sara.x + sara.width/2, sara.y + sara.height, 5, '#fff');
  }
  inp.jump = false;

  // Gravity
  sara.vy += GRAVITY;
  sara.y += sara.vy;

  // Ground
  sara.onGround = false;
  if (sara.y + sara.height >= GROUND_Y) {
    sara.y = GROUND_Y - sara.height;
    sara.vy = 0;
    sara.onGround = true;
  }

  // Platform collision
  for (const plat of game.platforms) {
    if (sara.vy >= 0 &&
        sara.x + sara.width > plat.x && sara.x < plat.x + plat.w &&
        sara.y + sara.height >= plat.y && sara.y + sara.height <= plat.y + plat.h + 10) {
      sara.y = plat.y - sara.height;
      sara.vy = 0;
      sara.onGround = true;
    }
  }

  // Animation
  if (sara.ducking) {
    sara.frame = 0;
  } else if (Math.abs(sara.vx) > 0.5 && sara.onGround) {
    sara.frameTimer++;
    if (sara.frameTimer > 8) { sara.frame = (sara.frame + 1) % 3; sara.frameTimer = 0; }
  } else if (!sara.onGround) {
    sara.frame = 1;
  } else {
    sara.frame = 0;
  }

  // Fell off left
  if (sara.x + sara.width < -20) { gameOver('Swept away by the blizzard!'); return; }

  const sx = game.scrollSpeed;

  // Platforms
  for (let i = game.platforms.length - 1; i >= 0; i--) {
    game.platforms[i].x -= sx;
    if (game.platforms[i].x + game.platforms[i].w < -60) game.platforms.splice(i, 1);
  }

  // Campfires - they burn and melt snow!
  for (let i = game.campfires.length - 1; i >= 0; i--) {
    const cf = game.campfires[i];
    cf.x -= sx;
    cf.life--;
    cf.frame++;
    if (cf.life <= 0) { game.campfires.splice(i, 1); continue; }

    // Melt nearby snowstorms
    const meltRange = 10 * SCALE;
    for (let j = game.snowstorms.length - 1; j >= 0; j--) {
      const ss = game.snowstorms[j];
      const dx = (cf.x + cf.width/2) - (ss.x + ss.width/2);
      const dy = (cf.y + cf.height/2) - (ss.y + ss.height/2);
      if (Math.abs(dx) < meltRange && Math.abs(dy) < meltRange) {
        game.score += 15;
        spawnParticles(ss.x + ss.width/2, ss.y, 8, '#87CEEB');
        game.particles.push({
          x: ss.x, y: ss.y - 15, vx: 0, vy: -1.2,
          life: 35, color: '#87CEEB', text: 'MELTED!', size: 3,
        });
        game.snowstorms.splice(j, 1);
      }
    }
    // Melt snowdrifts too
    for (let j = game.snowdrifts.length - 1; j >= 0; j--) {
      const sd = game.snowdrifts[j];
      const dx = (cf.x + cf.width/2) - (sd.x + sd.width/2);
      if (Math.abs(dx) < meltRange) {
        game.score += 10;
        spawnParticles(sd.x + sd.width/2, sd.y, 6, '#87CEEB');
        game.particles.push({
          x: sd.x, y: sd.y - 15, vx: 0, vy: -1.2,
          life: 35, color: '#87CEEB', text: 'MELTED!', size: 3,
        });
        game.snowdrifts.splice(j, 1);
      }
    }
  }

  // Snowdrifts
  for (let i = game.snowdrifts.length - 1; i >= 0; i--) {
    const sd = game.snowdrifts[i];
    sd.x -= sd.speed;
    if (sd.x + sd.width < -60) { game.snowdrifts.splice(i, 1); continue; }
    if (rectsOverlap(sara, sd)) {
      spawnParticles(sara.x + sara.width/2, sara.y + sara.height/2, 12, '#c8d0e0');
      gameOver('Crashed into a snowdrift!');
      return;
    }
  }

  // Snowstorms
  for (let i = game.snowstorms.length - 1; i >= 0; i--) {
    const ss = game.snowstorms[i];
    ss.x -= ss.speed;
    if (ss.x + ss.width < -60) { game.snowstorms.splice(i, 1); continue; }
    if (rectsOverlap(sara, ss)) {
      spawnParticles(sara.x + sara.width/2, sara.y + sara.height/2, 15, '#c8d0e0');
      gameOver('Hit by a snowstorm!');
      return;
    }
  }

  // Firewood
  for (let i = game.firewoods.length - 1; i >= 0; i--) {
    game.firewoods[i].x -= sx;
    if (game.firewoods[i].x < -60) { game.firewoods.splice(i, 1); continue; }
    if (rectsOverlap(sara, game.firewoods[i])) {
      game.firewood++;
      game.score += 25;
      spawnParticles(game.firewoods[i].x, game.firewoods[i].y, 5, '#D2691E');
      game.firewoods.splice(i, 1);
      updateActionBtns();
    }
  }

  // Burgers
  for (let i = game.burgerItems.length - 1; i >= 0; i--) {
    game.burgerItems[i].x -= sx;
    if (game.burgerItems[i].x < -60) { game.burgerItems.splice(i, 1); continue; }
    if (rectsOverlap(sara, game.burgerItems[i])) {
      game.burgers++;
      spawnParticles(game.burgerItems[i].x, game.burgerItems[i].y, 5, '#FFD700');
      game.burgerItems.splice(i, 1);
      updateActionBtns();
    }
  }

  // Cats with behaviors
  for (let i = game.cats.length - 1; i >= 0; i--) {
    const cat = game.cats[i];
    cat.frame++;

    if (cat.name === 'Effie') {
      // Effie: fast, darts back and forth unpredictably
      cat.dartTimer--;
      if (cat.dartTimer <= 0) {
        cat.dartDir *= -1;
        cat.dartTimer = 30 + Math.random() * 40;
      }
      cat.x -= cat.speed + cat.dartDir * 0.8;
      // Effie jumps frequently
      cat.jumpTimer--;
      if (cat.jumpTimer <= 0) {
        cat.vy = -7;
        cat.jumpTimer = 30 + Math.random() * 30;
      }
    } else {
      // Nora: slow, sits in the way, occasional lazy jump
      cat.x -= cat.speed;
      cat.jumpTimer--;
      if (cat.jumpTimer <= 0) {
        cat.vy = -4;
        cat.jumpTimer = 150 + Math.random() * 100;
      }
    }

    cat.vy += 0.3;
    cat.y += cat.vy;
    if (cat.y > cat.baseY) { cat.y = cat.baseY; cat.vy = 0; }

    if (cat.x < -100) { game.cats.splice(i, 1); continue; }
    if (rectsOverlap(sara, cat)) {
      const color = cat.name === 'Nora' ? '#8B5E3C' : '#E87A2E';
      spawnParticles(sara.x + sara.width/2, sara.y + sara.height/2, 10, color);
      gameOver('Tripped over ' + cat.name + '!');
      return;
    }
  }

  // Emily stays on right - update her position
  {
    const em = game.emily;
    em.x = W - em.width - 15;
    em.y = GROUND_Y - em.height;
  }

  // Thrown burgers - check collision with Emily (only when hungry)
  for (let i = game.thrownBurgers.length - 1; i >= 0; i--) {
    const tb = game.thrownBurgers[i];
    tb.x += tb.vx; tb.y += tb.vy; tb.vy += 0.12;
    if (tb.x > W + 60 || tb.y > H + 60 || tb.x < -60) {
      game.thrownBurgers.splice(i, 1); continue;
    }
    // Only feed Emily when she's hungry
    const em = game.emily;
    if (em.hungry && rectsOverlap(tb, em)) {
      em.timesFed++;
      em.hungry = false;
      em.hungryTimer = 150 + Math.random() * 150;
      // Grow Emily! She gets 8% bigger each feeding
      em.scale = 1.0 + em.timesFed * 0.08;
      em.width = Math.floor(em.baseWidth * em.scale);
      em.height = Math.floor(em.baseHeight * em.scale);
      em.y = GROUND_Y - em.height;
      game.score += 100;
      spawnParticles(em.x + em.width/2, em.y, 12, '#FFD700');
      game.particles.push({
        x: em.x + em.width/2, y: em.y - 20,
        vx: 0, vy: -1.5, life: 50, color: '#FFD700',
        text: '+100 YUM!', size: 3,
      });
      game.thrownBurgers.splice(i, 1);
      continue;
    }
  }

  // Particles
  for (let i = game.particles.length - 1; i >= 0; i--) {
    const pt = game.particles[i];
    pt.x += pt.vx; pt.y += pt.vy; pt.life--;
    if (pt.life <= 0) game.particles.splice(i, 1);
  }

  // Snowflakes
  for (const sf of game.snowflakes) {
    sf.x += sf.drift - sx * 0.3;
    sf.y += sf.speed;
    if (sf.y > H) { sf.y = -5; sf.x = Math.random() * W; }
    if (sf.x < -10) sf.x = W + 5;
  }

  if (game.frameCount % 10 === 0) game.score++;
  spawnEntities();
}

function rectsOverlap(a, b) {
  const s = 3;
  return a.x+s < b.x+b.width-s && a.x+a.width-s > b.x+s &&
         a.y+s < b.y+b.height-s && a.y+a.height-s > b.y+s;
}

function spawnParticles(x, y, count, color) {
  for (let i = 0; i < count; i++) {
    game.particles.push({
      x, y,
      vx: (Math.random()-0.5)*4, vy: (Math.random()-0.5)*4-1,
      life: 20 + Math.random()*15, color,
      size: Math.random()*3+1,
    });
  }
}

function gameOver(reason) {
  game.running = false;
  if (game.score > highScore) {
    highScore = game.score;
    localStorage.setItem('snowstorm_hi2', highScore.toString());
  }
  document.getElementById('final-score').textContent = 'Score: ' + game.score;
  document.getElementById('final-hi').textContent = 'Best: ' + highScore;
  document.getElementById('death-reason').textContent = reason;
  document.getElementById('gameover-screen').style.display = 'flex';
  document.getElementById('throw-btn').style.display = 'none';
  document.getElementById('fire-btn').style.display = 'none';
}

function throwBurger() {
  if (!game.running || game.burgers <= 0) return;
  game.burgers--;
  updateActionBtns();
  const s = game.sara;
  // Throw toward Emily (right side) - arc it over
  game.thrownBurgers.push({
    x: s.x + s.width, y: s.y + s.height * 0.3,
    vx: 6, vy: -2.5, width: 8*SCALE, height: 7*SCALE,
  });
}

function lightFire() {
  if (!game.running || game.firewood <= 0) return;
  game.firewood--;
  game.score += 10;
  updateActionBtns();
  const s = game.sara;
  game.campfires.push({
    x: s.x + s.width/2 - 4*SCALE,
    y: GROUND_Y - 8*SCALE,
    width: 8*SCALE, height: 8*SCALE,
    life: 180, // Burns for 3 seconds
    frame: 0,
  });
  spawnParticles(s.x + s.width/2, GROUND_Y - 8*SCALE, 5, '#ff8800');
}

function updateActionBtns() {
  const tb = document.getElementById('throw-btn');
  const fb = document.getElementById('fire-btn');
  tb.style.display = game.burgers > 0 ? 'flex' : 'none';
  tb.textContent = '\uD83C\uDF54' + game.burgers;
  fb.style.display = game.firewood > 0 ? 'flex' : 'none';
  fb.textContent = '\uD83D\uDD25' + game.firewood;
}

// ---- RENDERING ----
function draw() {
  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, '#1a1a3e');
  grad.addColorStop(0.4, '#2d3a5e');
  grad.addColorStop(0.7, '#4a5a7a');
  grad.addColorStop(1, '#6a7a9a');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, W, H);

  drawMountains();

  // Snowflakes behind
  ctx.globalAlpha = 0.5;
  for (const sf of game.snowflakes) {
    ctx.fillStyle = '#fff';
    ctx.fillRect(Math.floor(sf.x), Math.floor(sf.y), sf.size, sf.size);
  }
  ctx.globalAlpha = 1;

  // Ground
  ctx.fillStyle = '#e8eaf6';
  ctx.fillRect(0, GROUND_Y, W, H - GROUND_Y);
  for (let x = 0; x < W; x += 6) {
    const h = Math.sin(x * 0.05 + game.scrollX * 0.01) * 4 + 3;
    ctx.fillStyle = '#f0f2ff';
    ctx.fillRect(x, GROUND_Y - h, 6, h);
  }
  ctx.fillStyle = '#c0c8e0';
  ctx.fillRect(0, GROUND_Y, W, 2);

  // Platforms
  for (const plat of game.platforms) {
    ctx.fillStyle = '#8B7355';
    ctx.fillRect(Math.floor(plat.x), Math.floor(plat.y), plat.w, plat.h);
    ctx.fillStyle = '#e8eaf6';
    ctx.fillRect(Math.floor(plat.x), Math.floor(plat.y) - 3, plat.w, 4);
    ctx.fillStyle = '#7a6345';
    ctx.fillRect(Math.floor(plat.x) + 4, Math.floor(plat.y) + 2, plat.w - 8, 2);
  }

  // Campfires
  for (const cf of game.campfires) {
    drawPixelSprite(cf.x, cf.y, campfireSprite(cf.frame));
    // Warm glow
    const glowAlpha = 0.15 + Math.sin(cf.frame * 0.2) * 0.08;
    const glowR = 12 * SCALE;
    const grd = ctx.createRadialGradient(
      cf.x + cf.width/2, cf.y + cf.height/2, 0,
      cf.x + cf.width/2, cf.y + cf.height/2, glowR
    );
    grd.addColorStop(0, 'rgba(255,150,50,' + glowAlpha + ')');
    grd.addColorStop(1, 'rgba(255,80,0,0)');
    ctx.fillStyle = grd;
    ctx.fillRect(cf.x - glowR, cf.y - glowR, glowR*2 + cf.width, glowR*2 + cf.height);
  }

  // Snowdrifts
  for (const sd of game.snowdrifts) {
    drawPixelSprite(sd.x, sd.y, snowdriftSprite());
    ctx.globalAlpha = 0.15;
    ctx.fillStyle = '#a0b0d0';
    ctx.fillRect(Math.floor(sd.x)-2, Math.floor(sd.y)-2, sd.width+4, sd.height+4);
    ctx.globalAlpha = 1;
    // Label
    ctx.fillStyle = '#aac';
    ctx.font = Math.max(9, SCALE*2) + 'px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('JUMP!', Math.floor(sd.x + sd.width/2), Math.floor(sd.y - 4));
    ctx.textAlign = 'left';
  }

  // Firewood
  for (const fw of game.firewoods) {
    drawPixelSprite(fw.x, fw.y, firewoodSprite());
    ctx.globalAlpha = 0.2 + Math.sin(game.frameCount * 0.1) * 0.1;
    ctx.fillStyle = '#D2691E';
    ctx.fillRect(Math.floor(fw.x)-2, Math.floor(fw.y)-2, fw.width+4, fw.height+4);
    ctx.globalAlpha = 1;
  }

  // Burger items
  for (const bi of game.burgerItems) {
    drawPixelSprite(bi.x, bi.y, burgerSprite());
    ctx.globalAlpha = 0.15 + Math.sin(game.frameCount * 0.12) * 0.1;
    ctx.fillStyle = '#FFD700';
    ctx.fillRect(Math.floor(bi.x)-2, Math.floor(bi.y)-2, bi.width+4, bi.height+4);
    ctx.globalAlpha = 1;
  }

  // Snowstorms with DUCK/JUMP labels
  for (const ss of game.snowstorms) {
    const cols = Math.ceil(ss.width / (8 * SCALE));
    for (let c = 0; c < cols; c++) {
      drawPixelSprite(ss.x + c * 8 * SCALE, ss.y, snowstormSprite());
    }
    ctx.globalAlpha = 0.3;
    ctx.fillStyle = '#c8d0e0';
    const ox = Math.sin(game.frameCount * 0.15) * 4;
    ctx.fillRect(Math.floor(ss.x)+ox-4, Math.floor(ss.y)-4, ss.width+8, ss.height+8);
    ctx.globalAlpha = 1;
    // Hint label
    ctx.fillStyle = ss.isHigh ? '#ffaa55' : '#aac';
    ctx.font = 'bold ' + Math.max(9, SCALE*2) + 'px monospace';
    ctx.textAlign = 'center';
    ctx.fillText(ss.isHigh ? 'DUCK!' : 'JUMP!', Math.floor(ss.x + ss.width/2), Math.floor(ss.y - 4));
    ctx.textAlign = 'left';
  }

  // Cats - BIG with names and behaviors
  for (const cat of game.cats) {
    if (cat.name === 'Nora') {
      drawPixelSprite(cat.x, cat.y, noraSprite(cat.frame));
    } else {
      drawPixelSprite(cat.x, cat.y, effieSprite(cat.frame));
    }
    ctx.fillStyle = '#fff';
    ctx.font = 'bold ' + Math.max(12, SCALE*3) + 'px monospace';
    ctx.textAlign = 'center';
    ctx.fillText(cat.name, Math.floor(cat.x + cat.width/2), Math.floor(cat.y - 6));
    ctx.textAlign = 'left';
  }

  // Emily - persistent on the right
  {
    const em = game.emily;
    const emilyScale = SCALE * em.scale;
    drawPixelSprite(em.x, em.y, emilySprite(em.frame), emilyScale);

    // Name above
    ctx.fillStyle = '#ddd';
    ctx.font = 'bold ' + Math.max(10, SCALE*2.5) + 'px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('Emily', Math.floor(em.x + em.width/2), Math.floor(em.y - 8));

    // Times fed counter
    if (em.timesFed > 0) {
      ctx.fillStyle = '#fda';
      ctx.font = Math.max(9, SCALE*2) + 'px monospace';
      ctx.fillText('Fed: ' + em.timesFed, Math.floor(em.x + em.width/2), Math.floor(em.y - 20));
    }

    // HUNGRY!! speech bubble (only when hungry) - points left from Emily
    if (em.hungry) {
      const bubbleW = Math.max(85, SCALE * 22);
      const bx = em.x - bubbleW - 8;
      const by = em.y - 10;
      // Pulsing bubble
      const pulse = 1 + Math.sin(game.frameCount * 0.15) * 0.05;
      ctx.fillStyle = '#fff';
      ctx.fillRect(Math.floor(bx), Math.floor(by), bubbleW * pulse, 24);
      // Pointer triangle pointing right toward Emily
      ctx.beginPath();
      ctx.moveTo(Math.floor(bx + bubbleW), Math.floor(by + 8));
      ctx.lineTo(Math.floor(bx + bubbleW), Math.floor(by + 16));
      ctx.lineTo(Math.floor(bx + bubbleW + 8), Math.floor(by + 12));
      ctx.fill();
      ctx.fillStyle = '#c00';
      ctx.font = 'bold ' + Math.max(13, SCALE * 3.5) + 'px monospace';
      ctx.textAlign = 'left';
      ctx.fillText('HUNGRY!!', Math.floor(bx + 5), Math.floor(by + 17));
    }
    ctx.textAlign = 'left';
  }

  // Thrown burgers
  for (const tb of game.thrownBurgers) {
    drawPixelSprite(tb.x, tb.y, burgerSprite());
  }

  // Sara
  const sara = game.sara;
  ctx.save();
  if (sara.facing === -1) {
    ctx.translate(sara.x + sara.width, sara.y);
    ctx.scale(-1, 1);
    drawPixelSprite(0, 0, saraSprite(sara.frame, sara.ducking));
  } else {
    drawPixelSprite(sara.x, sara.y, saraSprite(sara.frame, sara.ducking));
  }
  ctx.restore();

  // Sara name
  ctx.fillStyle = '#fff';
  ctx.font = 'bold ' + Math.max(10, SCALE*2.5) + 'px monospace';
  ctx.textAlign = 'center';
  ctx.fillText('Sara', Math.floor(sara.x + sara.width/2), Math.floor(sara.y - 6));
  ctx.textAlign = 'left';

  // Particles
  for (const pt of game.particles) {
    ctx.globalAlpha = Math.min(1, pt.life / 35);
    if (pt.text) {
      ctx.fillStyle = pt.color;
      ctx.font = 'bold 14px monospace';
      ctx.fillText(pt.text, Math.floor(pt.x), Math.floor(pt.y));
    } else {
      ctx.fillStyle = pt.color;
      ctx.fillRect(Math.floor(pt.x), Math.floor(pt.y), pt.size, pt.size);
    }
    ctx.globalAlpha = 1;
  }

  // HUD
  document.getElementById('score-display').innerHTML =
    'SCORE: ' + game.score + '<br>WOOD: ' + game.firewood + '<br>BURGERS: ' + game.burgers;

  // Snowflakes in front
  ctx.globalAlpha = 0.7;
  for (let i = 0; i < 15; i++) {
    const sf = game.snowflakes[i];
    ctx.fillStyle = '#fff';
    ctx.fillRect(Math.floor(sf.x), Math.floor(sf.y), sf.size+1, sf.size+1);
  }
  ctx.globalAlpha = 1;
}

function drawMountains() {
  const o = (game.scrollX || 0) * 0.1;
  ctx.fillStyle = '#2a3050';
  ctx.beginPath(); ctx.moveTo(0, GROUND_Y);
  for (let x = 0; x <= W; x += 40) {
    ctx.lineTo(x, GROUND_Y - (Math.sin((x+o)*0.006)*80 + Math.sin((x+o)*0.002)*50 + 100));
  }
  ctx.lineTo(W, GROUND_Y); ctx.fill();

  ctx.fillStyle = '#3a4060';
  ctx.beginPath(); ctx.moveTo(0, GROUND_Y);
  for (let x = 0; x <= W; x += 30) {
    ctx.lineTo(x, GROUND_Y - (Math.sin((x+o*1.5)*0.01)*50 + Math.sin((x+o*1.5)*0.004)*30 + 70));
  }
  ctx.lineTo(W, GROUND_Y); ctx.fill();
}

// ---- GAME LOOP ----
let loopStarted = false;
function gameLoop() {
  if (game.running) { game.scrollX += game.scrollSpeed; update(); }
  draw();
  requestAnimationFrame(gameLoop);
}

// ---- INPUT ----
const btnLeft = document.getElementById('btn-left');
const btnDuck = document.getElementById('btn-duck');
const btnJump = document.getElementById('btn-jump');
const btnRight = document.getElementById('btn-right');
const throwBtn = document.getElementById('throw-btn');
const fireBtn = document.getElementById('fire-btn');

function ts(zone) {
  return function(e) {
    e.preventDefault();
    if (zone === 'left') game.input.left = true;
    if (zone === 'right') game.input.right = true;
    if (zone === 'jump') game.input.jump = true;
    if (zone === 'duck') game.input.duck = true;
  };
}
function te(zone) {
  return function(e) {
    e.preventDefault();
    if (zone === 'left') game.input.left = false;
    if (zone === 'right') game.input.right = false;
    if (zone === 'duck') game.input.duck = false;
  };
}

btnLeft.addEventListener('touchstart', ts('left'), {passive:false});
btnLeft.addEventListener('touchend', te('left'), {passive:false});
btnDuck.addEventListener('touchstart', ts('duck'), {passive:false});
btnDuck.addEventListener('touchend', te('duck'), {passive:false});
btnJump.addEventListener('touchstart', ts('jump'), {passive:false});
btnJump.addEventListener('touchend', te('jump'), {passive:false});
btnRight.addEventListener('touchstart', ts('right'), {passive:false});
btnRight.addEventListener('touchend', te('right'), {passive:false});

// Mouse fallback
btnLeft.addEventListener('mousedown', () => game.input.left = true);
btnLeft.addEventListener('mouseup', () => game.input.left = false);
btnLeft.addEventListener('mouseleave', () => game.input.left = false);
btnDuck.addEventListener('mousedown', () => game.input.duck = true);
btnDuck.addEventListener('mouseup', () => game.input.duck = false);
btnDuck.addEventListener('mouseleave', () => game.input.duck = false);
btnRight.addEventListener('mousedown', () => game.input.right = true);
btnRight.addEventListener('mouseup', () => game.input.right = false);
btnRight.addEventListener('mouseleave', () => game.input.right = false);
btnJump.addEventListener('mousedown', () => game.input.jump = true);

throwBtn.addEventListener('touchstart', (e) => { e.preventDefault(); throwBurger(); }, {passive:false});
throwBtn.addEventListener('click', () => throwBurger());
fireBtn.addEventListener('touchstart', (e) => { e.preventDefault(); lightFire(); }, {passive:false});
fireBtn.addEventListener('click', () => lightFire());

document.addEventListener('keydown', (e) => {
  if (e.code === 'ArrowLeft') game.input.left = true;
  if (e.code === 'ArrowRight') game.input.right = true;
  if (e.code === 'ArrowDown') game.input.duck = true;
  if (e.code === 'Space') { e.preventDefault(); game.input.jump = true; }
  if (e.code === 'KeyF') throwBurger();
  if (e.code === 'KeyX' || e.code === 'KeyC') lightFire();
});
document.addEventListener('keyup', (e) => {
  if (e.code === 'ArrowLeft') game.input.left = false;
  if (e.code === 'ArrowRight') game.input.right = false;
  if (e.code === 'ArrowDown') game.input.duck = false;
});

document.getElementById('start-btn').addEventListener('click', () => {
  document.getElementById('start-screen').style.display = 'none';
  initGame(); updateActionBtns();
  if (!loopStarted) { loopStarted = true; gameLoop(); }
});
document.getElementById('restart-btn').addEventListener('click', () => {
  document.getElementById('gameover-screen').style.display = 'none';
  initGame(); updateActionBtns();
  if (!loopStarted) { loopStarted = true; gameLoop(); }
});

document.addEventListener('touchmove', (e) => e.preventDefault(), {passive:false});
</script>
</body>
</html>
