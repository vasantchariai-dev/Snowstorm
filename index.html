<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>Snowstorm at Bjergvej</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  width: 100%; height: 100%;
  overflow: hidden;
  background: #1a1a2e;
  touch-action: none;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}
canvas {
  display: block;
  image-rendering: pixelated;
  image-rendering: crisp-edges;
}
#ui-overlay {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 10;
}
#score-display {
  position: absolute; top: 8px; left: 12px;
  font-family: monospace; font-size: 14px; color: #fff;
  text-shadow: 2px 2px 0 #000;
  line-height: 1.5;
}
#touch-controls {
  position: absolute; bottom: 0; left: 0; width: 100%; height: 35%;
  pointer-events: all; display: flex; z-index: 20;
}
.touch-zone {
  flex: 1; display: flex; align-items: center; justify-content: center;
  opacity: 0.12; font-size: 48px; color: #fff;
  border: 1px solid rgba(255,255,255,0.08);
}
.touch-zone:active { opacity: 0.25; }
#start-screen, #gameover-screen {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  background: rgba(10, 10, 30, 0.92); z-index: 30; pointer-events: all;
  font-family: monospace; color: #fff; text-align: center;
}
#start-screen h1 {
  font-size: 28px; margin-bottom: 6px;
  text-shadow: 3px 3px 0 #2d5f8a;
}
#start-screen .subtitle { font-size: 14px; color: #8ac; margin-bottom: 24px; }
#start-screen .instructions {
  font-size: 13px; color: #bbb; line-height: 1.8; margin-bottom: 24px; padding: 0 20px;
}
.play-btn {
  background: #4a9; color: #fff; border: none; padding: 16px 48px;
  font-family: monospace; font-size: 20px; cursor: pointer;
  border-radius: 4px; text-shadow: 1px 1px 0 #000;
  box-shadow: 0 4px 0 #387;
}
.play-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #387; }
#gameover-screen h2 { font-size: 24px; margin-bottom: 16px; color: #f66; }
#gameover-screen .final-score { font-size: 18px; margin-bottom: 8px; }
#gameover-screen .reason { font-size: 14px; color: #aaa; margin-bottom: 24px; }
#throw-btn {
  position: absolute; bottom: 37%; right: 16px;
  width: 64px; height: 64px; border-radius: 50%;
  background: rgba(255, 160, 60, 0.7); border: 2px solid rgba(255,200,100,0.8);
  color: #fff; font-size: 24px; z-index: 25;
  pointer-events: all; display: none;
  align-items: center; justify-content: center;
  font-family: monospace;
}
#throw-btn:active { background: rgba(255, 160, 60, 0.95); }
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="ui-overlay">
  <div id="score-display"></div>
</div>
<div id="touch-controls">
  <div class="touch-zone" id="btn-left">&#9664;</div>
  <div class="touch-zone" id="btn-jump">&#9650;</div>
  <div class="touch-zone" id="btn-right">&#9654;</div>
</div>
<button id="throw-btn">&#127828;</button>

<div id="start-screen">
  <h1>SNOWSTORM</h1>
  <div class="subtitle">at Bjergvej</div>
  <div class="instructions">
    Sara must survive the blizzard!<br><br>
    &#9664; LEFT &nbsp;|&nbsp; JUMP &#9650; &nbsp;|&nbsp; RIGHT &#9654;<br><br>
    Collect firewood &amp; burgers<br>
    Jump over snowdrifts and cats!<br>
    Feed Emily when she appears<br><br>
    Watch out for Effie &amp; Nora!
  </div>
  <button class="play-btn" id="start-btn">PLAY</button>
</div>

<div id="gameover-screen" style="display:none">
  <h2>GAME OVER</h2>
  <div class="final-score" id="final-score"></div>
  <div class="final-score" id="final-hi"></div>
  <div class="reason" id="death-reason"></div>
  <button class="play-btn" id="restart-btn">RETRY</button>
</div>

<script>
// ============================================================
// SNOWSTORM AT BJERGVEJ - Landscape-optimized Platformer
// ============================================================

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

// --- Responsive sizing - optimized for landscape ---
let W, H, SCALE, GROUND_Y;
function resize() {
  W = window.innerWidth;
  H = window.innerHeight;
  canvas.width = W;
  canvas.height = H;
  // Bigger scale: use the larger dimension for landscape phones
  const ref = Math.max(W, H);
  SCALE = Math.max(2, Math.round(ref / 160));
  // Cap scale so sprites don't get absurdly huge on tablets
  if (SCALE > 6) SCALE = 6;
  GROUND_Y = H - 60;
}
resize();
window.addEventListener('resize', resize);

// --- Pixel art drawing helpers ---
function drawPixelSprite(x, y, pixels, scale) {
  const s = scale || SCALE;
  for (let row = 0; row < pixels.length; row++) {
    for (let col = 0; col < pixels[row].length; col++) {
      if (pixels[row][col]) {
        ctx.fillStyle = pixels[row][col];
        ctx.fillRect(
          Math.floor(x + col * s),
          Math.floor(y + row * s),
          s, s
        );
      }
    }
  }
}

// --- SPRITE DATA ---

// Sara: short-haired woman in flannel shirt (12x16)
function saraSprite(frame) {
  const _ = null;
  const h = '#5a3825', s = '#f5c6a0', e = '#222';
  const f1 = '#c0392b', f2 = '#2c3e50', p = '#34495e', b = '#2c2c2c', m = '#d9a88c';
  const base = [
    [_,_,_,h,h,h,h,h,h,_,_,_],
    [_,_,h,h,h,h,h,h,h,h,_,_],
    [_,_,h,s,s,s,s,s,s,h,_,_],
    [_,_,s,s,e,s,s,e,s,s,_,_],
    [_,_,s,s,s,s,s,s,s,s,_,_],
    [_,_,_,s,s,m,s,s,_,_,_,_],
    [_,_,_,f1,f2,f1,f2,f1,_,_,_,_],
    [_,_,f1,f1,f2,f1,f2,f1,f1,_,_,_],
    [_,s,f1,f2,f1,f2,f1,f2,f1,s,_,_],
    [_,_,f1,f2,f1,f2,f1,f2,f1,_,_,_],
    [_,_,_,f1,f2,f1,f2,f1,_,_,_,_],
    [_,_,_,_,p,p,p,p,_,_,_,_],
    [_,_,_,_,p,p,p,p,_,_,_,_],
    [_,_,_,p,p,_,_,p,p,_,_,_],
    [_,_,_,b,b,_,_,b,b,_,_,_],
    [_,_,b,b,b,_,_,b,b,b,_,_],
  ];
  if (frame === 1) {
    base[13] = [_,_,p,p,_,_,_,_,p,p,_,_];
    base[14] = [_,b,b,b,_,_,_,_,b,b,_,_];
    base[15] = [_,b,b,_,_,_,_,_,_,b,b,_];
  } else if (frame === 2) {
    base[13] = [_,_,_,_,p,p,p,p,_,_,_,_];
    base[14] = [_,_,_,_,b,b,b,b,_,_,_,_];
    base[15] = [_,_,_,b,b,_,_,b,b,_,_,_];
  }
  return base;
}

// Emily: taller woman (14x20) with long brown hair, purple top
function emilySprite(frame) {
  const _ = null;
  const h = '#6b3a2a', s = '#f5c6a0', e = '#222', m = '#d9a88c';
  const d = '#6a5acd', d2 = '#483d8b', p = '#34495e', b = '#2c2c2c';
  const base = [
    [_,_,_,_,h,h,h,h,h,h,_,_,_,_],
    [_,_,_,h,h,h,h,h,h,h,h,_,_,_],
    [_,_,h,h,h,h,h,h,h,h,h,h,_,_],
    [_,_,h,s,s,s,s,s,s,s,s,h,_,_],
    [_,_,h,s,e,s,s,s,e,s,s,h,_,_],
    [_,_,h,s,s,s,s,s,s,s,s,h,_,_],
    [_,_,h,_,s,s,m,s,s,_,_,h,_,_],
    [_,_,h,_,_,d,d2,d,_,_,_,h,_,_],
    [_,_,h,_,d,d,d2,d,d,_,_,h,_,_],
    [_,_,h,d,d,d2,d,d2,d,d,_,h,_,_],
    [_,s,h,d,d2,d,d2,d,d2,d,h,s,_,_],
    [_,_,h,d,d,d2,d,d2,d,d,h,_,_,_],
    [_,_,_,_,d,d2,d,d2,d,_,_,_,_,_],
    [_,_,_,_,_,p,p,p,p,_,_,_,_,_],
    [_,_,_,_,_,p,p,p,p,_,_,_,_,_],
    [_,_,_,_,_,p,p,p,p,_,_,_,_,_],
    [_,_,_,_,p,p,_,_,p,p,_,_,_,_],
    [_,_,_,_,p,p,_,_,p,p,_,_,_,_],
    [_,_,_,_,b,b,_,_,b,b,_,_,_,_],
    [_,_,_,b,b,b,_,_,b,b,b,_,_,_],
  ];
  // Wave hands when hungry
  if (Math.floor(frame / 15) % 2 === 0) {
    base[10] = [s,s,h,d,d2,d,d2,d,d2,d,h,s,s,_];
  }
  return base;
}

// Nora: big fluffy brown cat (16x12)
function noraSprite() {
  const _ = null;
  const c = '#8B5E3C', c2 = '#A0724B', f = '#C4956A'; // brown + fluffy highlights
  const e = '#4a4', n = '#faa', w = '#fff';
  return [
    [_,c,c,_,_,_,_,_,_,_,_,_,_,c,c,_],
    [c,c2,c,c,_,_,_,_,_,_,_,_,c,c2,c,_],
    [c,f,c2,c,c,c,c,c,c,c,c,c,c,f,c,_],
    [c,f,f,c2,c,c,c,c,c,c,c,c2,f,f,c,_],
    [c,c2,f,c2,c,c,c,c,c,c,c2,f,c2,c,c,_],
    [c,c,e,w,c,c,c,c,c,c,e,w,c,c,c,_],
    [c,c2,c,c,c,n,n,c,c,c,c,c,c,c2,c,_],
    [c,f,c2,c,c,c,c,c,c,c,c,c2,f,c,c,_],
    [_,c,f,c2,c,c,c,c,c,c,c2,f,c,_,_,_],
    [_,_,c,f,c,c,c,c,c,c,f,c,_,_,_,_],
    [_,_,c,_,c,c,_,_,c,c,_,c,_,_,_,_],
    [_,_,c,_,c,c,_,_,c,c,_,c,_,_,_,_],
  ];
}

// Effie: ginger and white cat (14x10)
function effieSprite() {
  const _ = null;
  const g = '#E87A2E', g2 = '#D46A1E', w = '#fff', ww = '#f0e8e0';
  const e = '#4c4', n = '#faa';
  return [
    [_,g,g,_,_,_,_,_,_,_,_,g,g,_],
    [g,g2,g,g,_,_,_,_,_,_,g,g2,g,_],
    [g,w,g2,g,g,g,g,g,g,g,g,w,g,_],
    [g,w,w,g,g,g,g,g,g,g,w,w,g,_],
    [g,w,e,ww,g,g,g,g,g,e,ww,w,g,_],
    [g,w,w,g,g,n,g,g,g,w,w,g,g,_],
    [g,g,w,w,g,g,g,g,w,w,g,g,g,_],
    [_,g,g,w,w,g,g,w,w,g,g,_,_,_],
    [_,_,g,_,g,g,_,g,g,_,g,_,_,_],
    [_,_,g,_,g,g,_,g,g,_,g,_,_,_],
  ];
}

// Snowstorm block (8x8)
function snowstormSprite() {
  const w = '#e8eaf0', w2 = '#c8d0e0', b = '#a0b0d0', _ = null;
  return [
    [_,w,w,w2,w2,w,w,_],
    [w,w2,w,b,w,w2,w,w],
    [w,w,b,w2,b,w,w2,w],
    [w2,b,w2,w,w2,b,w,w2],
    [w,w2,w,b,w,w2,b,w],
    [w2,w,b,w2,b,w,w2,w],
    [w,w2,w,w,w2,w,w,w2],
    [_,w,w2,w,w,w2,w,_],
  ];
}

// Snowdrift ground obstacle (10x6) - must jump over
function snowdriftSprite() {
  const w = '#dde0f0', w2 = '#c5cae0', b = '#b0b8d0', _ = null;
  return [
    [_,_,_,_,w,w,_,_,_,_],
    [_,_,_,w,w2,w,w,_,_,_],
    [_,_,w,w2,b,w2,w,w,_,_],
    [_,w,w2,b,w2,b,w2,w,w,_],
    [w,w2,b,w2,w,w2,b,w2,w,w],
    [w,w,w2,w,w,w,w2,w,w,w],
  ];
}

// Firewood (8x6)
function firewoodSprite() {
  const br = '#8B4513', db = '#654321', o = '#D2691E', _ = null;
  return [
    [_,_,br,br,br,br,_,_],
    [_,br,db,o,db,o,br,_],
    [br,o,db,br,o,db,o,br],
    [br,db,o,db,br,o,db,br],
    [_,br,db,o,db,o,br,_],
    [_,_,br,br,br,br,_,_],
  ];
}

// Burger (8x7)
function burgerSprite() {
  const bn = '#D2A050', mt = '#8B2500', lt = '#4CAF50', ch = '#FFD700', tm = '#ff4444', _ = null;
  return [
    [_,_,bn,bn,bn,bn,_,_],
    [_,bn,bn,bn,bn,bn,bn,_],
    [lt,lt,lt,lt,lt,lt,lt,lt],
    [mt,mt,ch,mt,mt,ch,mt,mt],
    [mt,ch,mt,mt,ch,mt,mt,mt],
    [tm,tm,tm,tm,tm,tm,tm,tm],
    [_,bn,bn,bn,bn,bn,bn,_],
  ];
}

// --- GAME STATE ---
const GRAVITY = 0.4;
const JUMP_FORCE = -10;
const MOVE_SPEED = 3.5;
const SCROLL_SPEED_BASE = 1.0;

let game = {};
let highScore = parseInt(localStorage.getItem('snowstorm_hi') || '0');

function initGame() {
  const saraH = 16 * SCALE;
  game = {
    running: true,
    score: 0,
    firewood: 0,
    burgers: 0,
    scrollSpeed: SCROLL_SPEED_BASE,
    scrollX: 0,
    frameCount: 0,
    deathReason: '',

    sara: {
      x: W * 0.25,
      y: GROUND_Y - saraH,
      vy: 0,
      vx: 0,
      onGround: true,
      width: 12 * SCALE,
      height: saraH,
      frame: 0,
      frameTimer: 0,
      facing: 1,
    },

    platforms: [],
    snowstorms: [],
    snowdrifts: [],
    firewoods: [],
    burgerItems: [],
    cats: [],
    emilys: [],
    thrownBurgers: [],
    particles: [],
    snowflakes: [],

    spawnTimer: 0,
    emilyTimer: 350,
    difficultyTimer: 0,

    input: { left: false, right: false, jump: false },
  };

  // Init snowflakes
  for (let i = 0; i < 80; i++) {
    game.snowflakes.push({
      x: Math.random() * W,
      y: Math.random() * H,
      size: Math.random() * 3 + 1,
      speed: Math.random() * 1.5 + 0.5,
      drift: Math.random() * 0.8 - 0.4,
    });
  }

  // Generate initial platforms with collectibles on them
  generateInitialPlatforms();
}

function generateInitialPlatforms() {
  let x = W * 0.6;
  for (let i = 0; i < 6; i++) {
    x += Math.random() * 140 + 100;
    const pw = Math.random() * 80 + 60;
    const py = GROUND_Y - Math.random() * 80 - 50;
    game.platforms.push({ x, y: py, w: pw, h: 8 * SCALE });
    // Place a collectible on some platforms
    if (Math.random() > 0.4) {
      const itemY = py - 7 * SCALE;
      if (Math.random() > 0.5) {
        game.firewoods.push({ x: x + pw / 2 - 4 * SCALE, y: itemY, width: 8 * SCALE, height: 6 * SCALE });
      } else {
        game.burgerItems.push({ x: x + pw / 2 - 4 * SCALE, y: itemY, width: 8 * SCALE, height: 7 * SCALE });
      }
    }
  }
}

// --- SPAWNING ---
function spawnEntities() {
  game.spawnTimer++;
  const diff = Math.min(game.score / 800, 2.5);

  // Platforms - spawn regularly with collectibles on top
  if (game.spawnTimer % Math.max(50, 80 - diff * 6) === 0) {
    const py = GROUND_Y - Math.random() * 90 - 45;
    const pw = Math.random() * 80 + 55;
    game.platforms.push({ x: W + 40, y: py, w: pw, h: 8 * SCALE });
    // Often put a collectible on the platform - gives reason to jump up
    if (Math.random() > 0.3) {
      const itemY = py - 7 * SCALE;
      if (Math.random() > 0.5) {
        game.firewoods.push({ x: W + 40 + pw / 2 - 4 * SCALE, y: itemY, width: 8 * SCALE, height: 6 * SCALE });
      } else {
        game.burgerItems.push({ x: W + 40 + pw / 2 - 4 * SCALE, y: itemY, width: 8 * SCALE, height: 7 * SCALE });
      }
    }
  }

  // Snowdrifts on ground - MUST jump over these
  if (game.spawnTimer % Math.max(60, 100 - diff * 8) === 0) {
    game.snowdrifts.push({
      x: W + 40,
      y: GROUND_Y - 6 * SCALE,
      width: 10 * SCALE,
      height: 6 * SCALE,
      speed: game.scrollSpeed,
    });
  }

  // Flying snowstorms - slower approach
  if (game.spawnTimer % Math.max(80, 120 - diff * 10) === 0) {
    const sy = GROUND_Y - Math.random() * 80 - 16 * SCALE;
    game.snowstorms.push({
      x: W + 40, y: sy,
      width: 8 * SCALE * (Math.random() > 0.6 ? 2 : 1),
      height: 8 * SCALE,
      speed: game.scrollSpeed + 0.3 + Math.random() * 0.7,
    });
  }

  // Firewood on ground too
  if (game.spawnTimer % 120 === 0 && Math.random() > 0.4) {
    game.firewoods.push({
      x: W + 40,
      y: GROUND_Y - 6 * SCALE,
      width: 8 * SCALE,
      height: 6 * SCALE,
    });
  }

  // Burgers on ground sometimes
  if (game.spawnTimer % 180 === 0 && Math.random() > 0.5) {
    game.burgerItems.push({
      x: W + 40,
      y: GROUND_Y - 7 * SCALE,
      width: 8 * SCALE,
      height: 7 * SCALE,
    });
  }

  // Cats: alternate between Nora and Effie
  if (game.spawnTimer % Math.max(150, 250 - diff * 15) === 0 && Math.random() > 0.3) {
    const isNora = Math.random() > 0.5;
    const catW = isNora ? 16 * SCALE : 14 * SCALE;
    const catH = isNora ? 12 * SCALE : 10 * SCALE;
    game.cats.push({
      x: W + 40,
      y: GROUND_Y - catH,
      width: catW,
      height: catH,
      speed: game.scrollSpeed + 0.3 + Math.random() * 0.4,
      name: isNora ? 'Nora' : 'Effie',
      jumpTimer: 60 + Math.random() * 80,
      vy: 0,
      baseY: GROUND_Y - catH,
    });
  }

  // Emily - appears periodically
  game.emilyTimer--;
  if (game.emilyTimer <= 0) {
    const emilyH = 20 * SCALE;
    game.emilys.push({
      x: W + 40,
      y: GROUND_Y - emilyH,
      width: 14 * SCALE,
      height: emilyH,
      timer: 400,
      fed: false,
      frame: 0,
    });
    game.emilyTimer = 450 + Math.random() * 200;
  }
}

// --- PHYSICS & UPDATE ---
function update() {
  if (!game.running) return;

  game.frameCount++;
  game.difficultyTimer++;
  // Very gradual difficulty increase
  if (game.difficultyTimer % 900 === 0) {
    game.scrollSpeed = Math.min(SCROLL_SPEED_BASE + game.difficultyTimer / 2000, 3.0);
  }

  const sara = game.sara;
  const inp = game.input;

  // Horizontal movement
  if (inp.left) {
    sara.vx = -MOVE_SPEED;
    sara.facing = -1;
  } else if (inp.right) {
    sara.vx = MOVE_SPEED;
    sara.facing = 1;
  } else {
    sara.vx *= 0.7;
    if (Math.abs(sara.vx) < 0.2) sara.vx = 0;
  }

  // Auto-scroll push (gentle)
  sara.x -= game.scrollSpeed * 0.4;
  sara.x += sara.vx;

  // Clamp horizontal
  if (sara.x < 0) sara.x = 0;
  if (sara.x + sara.width > W) sara.x = W - sara.width;

  // Jump
  if (inp.jump && sara.onGround) {
    sara.vy = JUMP_FORCE;
    sara.onGround = false;
    spawnParticles(sara.x + sara.width / 2, sara.y + sara.height, 5, '#fff');
  }
  inp.jump = false;

  // Gravity (lower = floatier, more forgiving)
  sara.vy += GRAVITY;
  sara.y += sara.vy;

  // Ground collision
  sara.onGround = false;
  if (sara.y + sara.height >= GROUND_Y) {
    sara.y = GROUND_Y - sara.height;
    sara.vy = 0;
    sara.onGround = true;
  }

  // Platform collision
  for (const plat of game.platforms) {
    if (sara.vy >= 0 &&
        sara.x + sara.width > plat.x && sara.x < plat.x + plat.w &&
        sara.y + sara.height >= plat.y && sara.y + sara.height <= plat.y + plat.h + 10) {
      sara.y = plat.y - sara.height;
      sara.vy = 0;
      sara.onGround = true;
    }
  }

  // Animation
  if (Math.abs(sara.vx) > 0.5 && sara.onGround) {
    sara.frameTimer++;
    if (sara.frameTimer > 8) {
      sara.frame = (sara.frame + 1) % 3;
      sara.frameTimer = 0;
    }
  } else if (!sara.onGround) {
    sara.frame = 1;
  } else {
    sara.frame = 0;
  }

  // Fell off left side
  if (sara.x + sara.width < -20) {
    gameOver('Swept away by the blizzard!');
    return;
  }

  const sx = game.scrollSpeed;

  // Platforms
  for (let i = game.platforms.length - 1; i >= 0; i--) {
    game.platforms[i].x -= sx;
    if (game.platforms[i].x + game.platforms[i].w < -60) game.platforms.splice(i, 1);
  }

  // Snowdrifts (ground obstacles - must jump)
  for (let i = game.snowdrifts.length - 1; i >= 0; i--) {
    const sd = game.snowdrifts[i];
    sd.x -= sd.speed;
    if (sd.x + sd.width < -60) { game.snowdrifts.splice(i, 1); continue; }
    if (rectsOverlap(sara, sd)) {
      spawnParticles(sara.x + sara.width / 2, sara.y + sara.height / 2, 12, '#c8d0e0');
      gameOver('Crashed into a snowdrift!');
      return;
    }
  }

  // Snowstorms (flying)
  for (let i = game.snowstorms.length - 1; i >= 0; i--) {
    const ss = game.snowstorms[i];
    ss.x -= ss.speed;
    if (ss.x + ss.width < -60) { game.snowstorms.splice(i, 1); continue; }
    if (rectsOverlap(sara, ss)) {
      spawnParticles(sara.x + sara.width / 2, sara.y + sara.height / 2, 15, '#c8d0e0');
      gameOver('Hit by a snowstorm!');
      return;
    }
  }

  // Firewood
  for (let i = game.firewoods.length - 1; i >= 0; i--) {
    game.firewoods[i].x -= sx;
    if (game.firewoods[i].x < -60) { game.firewoods.splice(i, 1); continue; }
    if (rectsOverlap(sara, game.firewoods[i])) {
      game.firewood++;
      game.score += 25;
      spawnParticles(game.firewoods[i].x, game.firewoods[i].y, 5, '#D2691E');
      game.firewoods.splice(i, 1);
    }
  }

  // Burger items
  for (let i = game.burgerItems.length - 1; i >= 0; i--) {
    game.burgerItems[i].x -= sx;
    if (game.burgerItems[i].x < -60) { game.burgerItems.splice(i, 1); continue; }
    if (rectsOverlap(sara, game.burgerItems[i])) {
      game.burgers++;
      spawnParticles(game.burgerItems[i].x, game.burgerItems[i].y, 5, '#FFD700');
      game.burgerItems.splice(i, 1);
      updateThrowBtn();
    }
  }

  // Cats
  for (let i = game.cats.length - 1; i >= 0; i--) {
    const cat = game.cats[i];
    cat.x -= cat.speed;
    cat.jumpTimer--;
    if (cat.jumpTimer <= 0) {
      cat.vy = -5;
      cat.jumpTimer = 100 + Math.random() * 80;
    }
    cat.vy += 0.3;
    cat.y += cat.vy;
    if (cat.y > cat.baseY) { cat.y = cat.baseY; cat.vy = 0; }

    if (cat.x < -80) { game.cats.splice(i, 1); continue; }
    if (rectsOverlap(sara, cat)) {
      spawnParticles(sara.x + sara.width / 2, sara.y + sara.height / 2, 10, cat.name === 'Nora' ? '#8B5E3C' : '#E87A2E');
      gameOver('Tripped over ' + cat.name + '!');
      return;
    }
  }

  // Emily
  for (let i = game.emilys.length - 1; i >= 0; i--) {
    const em = game.emilys[i];
    em.x -= sx * 0.25;
    em.timer--;
    em.frame++;
    if (em.timer <= 0 || em.x < -80) { game.emilys.splice(i, 1); continue; }
  }

  // Thrown burgers
  for (let i = game.thrownBurgers.length - 1; i >= 0; i--) {
    const tb = game.thrownBurgers[i];
    tb.x += tb.vx;
    tb.y += tb.vy;
    tb.vy += 0.12;
    if (tb.x > W + 60 || tb.y > H + 60) { game.thrownBurgers.splice(i, 1); continue; }

    for (let j = game.emilys.length - 1; j >= 0; j--) {
      if (rectsOverlap(tb, game.emilys[j])) {
        game.score += 100;
        spawnParticles(game.emilys[j].x + game.emilys[j].width / 2, game.emilys[j].y, 12, '#FFD700');
        game.particles.push({
          x: game.emilys[j].x, y: game.emilys[j].y - 20,
          vx: 0, vy: -1.5, life: 50, color: '#FFD700', text: '+100', size: 3,
        });
        game.emilys.splice(j, 1);
        game.thrownBurgers.splice(i, 1);
        break;
      }
    }
  }

  // Particles
  for (let i = game.particles.length - 1; i >= 0; i--) {
    const pt = game.particles[i];
    pt.x += pt.vx;
    pt.y += pt.vy;
    pt.life--;
    if (pt.life <= 0) game.particles.splice(i, 1);
  }

  // Snowflakes
  for (const sf of game.snowflakes) {
    sf.x += sf.drift - sx * 0.3;
    sf.y += sf.speed;
    if (sf.y > H) { sf.y = -5; sf.x = Math.random() * W; }
    if (sf.x < -10) sf.x = W + 5;
  }

  // Score from survival
  if (game.frameCount % 10 === 0) game.score++;

  spawnEntities();
}

function rectsOverlap(a, b) {
  const shrink = 3;
  return (
    a.x + shrink < b.x + b.width - shrink &&
    a.x + a.width - shrink > b.x + shrink &&
    a.y + shrink < b.y + b.height - shrink &&
    a.y + a.height - shrink > b.y + shrink
  );
}

function spawnParticles(x, y, count, color) {
  for (let i = 0; i < count; i++) {
    game.particles.push({
      x, y,
      vx: (Math.random() - 0.5) * 4,
      vy: (Math.random() - 0.5) * 4 - 1,
      life: 20 + Math.random() * 15,
      color,
      size: Math.random() * 3 + 1,
    });
  }
}

function gameOver(reason) {
  game.running = false;
  game.deathReason = reason;
  if (game.score > highScore) {
    highScore = game.score;
    localStorage.setItem('snowstorm_hi', highScore.toString());
  }
  document.getElementById('final-score').textContent = 'Score: ' + game.score;
  document.getElementById('final-hi').textContent = 'Best: ' + highScore;
  document.getElementById('death-reason').textContent = reason;
  document.getElementById('gameover-screen').style.display = 'flex';
  document.getElementById('throw-btn').style.display = 'none';
}

function throwBurger() {
  if (game.burgers <= 0 || !game.running) return;
  game.burgers--;
  updateThrowBtn();
  const sara = game.sara;
  game.thrownBurgers.push({
    x: sara.x + sara.width,
    y: sara.y + sara.height * 0.3,
    vx: 6,
    vy: -1.5,
    width: 8 * SCALE,
    height: 7 * SCALE,
  });
}

function updateThrowBtn() {
  const btn = document.getElementById('throw-btn');
  if (game.burgers > 0) {
    btn.style.display = 'flex';
    btn.textContent = '\uD83C\uDF54' + game.burgers;
  } else {
    btn.style.display = 'none';
  }
}

// --- RENDERING ---
function draw() {
  // Sky gradient
  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, '#1a1a3e');
  grad.addColorStop(0.4, '#2d3a5e');
  grad.addColorStop(0.7, '#4a5a7a');
  grad.addColorStop(1, '#6a7a9a');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, W, H);

  drawMountains();

  // Snowflakes behind
  ctx.globalAlpha = 0.5;
  for (const sf of game.snowflakes) {
    ctx.fillStyle = '#fff';
    ctx.fillRect(Math.floor(sf.x), Math.floor(sf.y), sf.size, sf.size);
  }
  ctx.globalAlpha = 1;

  // Ground
  ctx.fillStyle = '#e8eaf6';
  ctx.fillRect(0, GROUND_Y, W, H - GROUND_Y);
  // Snow texture
  for (let x = 0; x < W; x += 6) {
    const h = Math.sin(x * 0.05 + game.scrollX * 0.01) * 4 + 3;
    ctx.fillStyle = '#f0f2ff';
    ctx.fillRect(x, GROUND_Y - h, 6, h);
  }
  ctx.fillStyle = '#c0c8e0';
  ctx.fillRect(0, GROUND_Y, W, 2);

  // Platforms
  for (const plat of game.platforms) {
    ctx.fillStyle = '#8B7355';
    ctx.fillRect(Math.floor(plat.x), Math.floor(plat.y), plat.w, plat.h);
    ctx.fillStyle = '#e8eaf6';
    ctx.fillRect(Math.floor(plat.x), Math.floor(plat.y) - 3, plat.w, 4);
    ctx.fillStyle = '#7a6345';
    ctx.fillRect(Math.floor(plat.x) + 4, Math.floor(plat.y) + 2, plat.w - 8, 2);
  }

  // Snowdrifts
  for (const sd of game.snowdrifts) {
    drawPixelSprite(sd.x, sd.y, snowdriftSprite());
    // Danger glow
    ctx.globalAlpha = 0.15 + Math.sin(game.frameCount * 0.08) * 0.08;
    ctx.fillStyle = '#a0b0d0';
    ctx.fillRect(Math.floor(sd.x) - 2, Math.floor(sd.y) - 2, sd.width + 4, sd.height + 4);
    ctx.globalAlpha = 1;
  }

  // Firewood
  for (const fw of game.firewoods) {
    drawPixelSprite(fw.x, fw.y, firewoodSprite());
    ctx.globalAlpha = 0.2 + Math.sin(game.frameCount * 0.1) * 0.1;
    ctx.fillStyle = '#D2691E';
    ctx.fillRect(Math.floor(fw.x) - 2, Math.floor(fw.y) - 2, fw.width + 4, fw.height + 4);
    ctx.globalAlpha = 1;
  }

  // Burger items
  for (const bi of game.burgerItems) {
    drawPixelSprite(bi.x, bi.y, burgerSprite());
    ctx.globalAlpha = 0.15 + Math.sin(game.frameCount * 0.12) * 0.1;
    ctx.fillStyle = '#FFD700';
    ctx.fillRect(Math.floor(bi.x) - 2, Math.floor(bi.y) - 2, bi.width + 4, bi.height + 4);
    ctx.globalAlpha = 1;
  }

  // Snowstorms
  for (const ss of game.snowstorms) {
    const cols = Math.ceil(ss.width / (8 * SCALE));
    for (let c = 0; c < cols; c++) {
      drawPixelSprite(ss.x + c * 8 * SCALE, ss.y, snowstormSprite());
    }
    ctx.globalAlpha = 0.3;
    ctx.fillStyle = '#c8d0e0';
    const ox = Math.sin(game.frameCount * 0.15) * 4;
    ctx.fillRect(Math.floor(ss.x) + ox - 4, Math.floor(ss.y) - 4, ss.width + 8, ss.height + 8);
    ctx.globalAlpha = 1;
  }

  // Cats - BIG and named
  for (const cat of game.cats) {
    if (cat.name === 'Nora') {
      drawPixelSprite(cat.x, cat.y, noraSprite());
    } else {
      drawPixelSprite(cat.x, cat.y, effieSprite());
    }
    // Name label above cat
    ctx.fillStyle = '#fff';
    ctx.font = 'bold ' + Math.max(12, SCALE * 3) + 'px monospace';
    ctx.textAlign = 'center';
    ctx.fillText(cat.name, Math.floor(cat.x + cat.width / 2), Math.floor(cat.y - 6));
    ctx.textAlign = 'left';
  }

  // Emily - tall with long brown hair
  for (const em of game.emilys) {
    drawPixelSprite(em.x, em.y, emilySprite(em.frame));
    if (!em.fed) {
      // Speech bubble
      const bx = em.x - 5;
      const by = em.y - 28;
      ctx.fillStyle = '#fff';
      const bubbleW = Math.max(75, SCALE * 20);
      ctx.fillRect(Math.floor(bx), Math.floor(by), bubbleW, 22);
      // Triangle pointer
      ctx.beginPath();
      ctx.moveTo(Math.floor(em.x + 15), Math.floor(by + 22));
      ctx.lineTo(Math.floor(em.x + 25), Math.floor(by + 22));
      ctx.lineTo(Math.floor(em.x + 18), Math.floor(by + 30));
      ctx.fill();
      ctx.fillStyle = '#333';
      ctx.font = 'bold ' + Math.max(12, SCALE * 3.5) + 'px monospace';
      ctx.fillText('HUNGRY!', Math.floor(bx + 5), Math.floor(by + 16));
      // Name
      ctx.fillStyle = '#ddd';
      ctx.font = Math.max(10, SCALE * 2.5) + 'px monospace';
      ctx.fillText('Emily', Math.floor(em.x + em.width / 2 - 12), Math.floor(em.y - 32));
    }
  }

  // Thrown burgers
  for (const tb of game.thrownBurgers) {
    drawPixelSprite(tb.x, tb.y, burgerSprite());
  }

  // Sara
  const sara = game.sara;
  ctx.save();
  if (sara.facing === -1) {
    ctx.translate(sara.x + sara.width, sara.y);
    ctx.scale(-1, 1);
    drawPixelSprite(0, 0, saraSprite(sara.frame));
  } else {
    drawPixelSprite(sara.x, sara.y, saraSprite(sara.frame));
  }
  ctx.restore();

  // Sara name
  ctx.fillStyle = '#fff';
  ctx.font = 'bold ' + Math.max(10, SCALE * 2.5) + 'px monospace';
  ctx.textAlign = 'center';
  ctx.fillText('Sara', Math.floor(sara.x + sara.width / 2), Math.floor(sara.y - 6));
  ctx.textAlign = 'left';

  // Carrying indicator
  if (game.firewood > 0) {
    ctx.fillStyle = '#D2691E';
    ctx.font = Math.max(10, SCALE * 3) + 'px monospace';
    ctx.fillText('\uD83E\uDEB5' + game.firewood, Math.floor(sara.x - 5), Math.floor(sara.y - 18));
  }

  // Particles
  for (const pt of game.particles) {
    const alpha = pt.life / 35;
    ctx.globalAlpha = Math.min(1, alpha);
    if (pt.text) {
      ctx.fillStyle = pt.color;
      ctx.font = 'bold 16px monospace';
      ctx.fillText(pt.text, Math.floor(pt.x), Math.floor(pt.y));
    } else {
      ctx.fillStyle = pt.color;
      ctx.fillRect(Math.floor(pt.x), Math.floor(pt.y), pt.size, pt.size);
    }
    ctx.globalAlpha = 1;
  }

  // HUD
  const hud = document.getElementById('score-display');
  hud.innerHTML = 'SCORE: ' + game.score + '<br>WOOD: ' + game.firewood + '<br>BURGERS: ' + game.burgers;

  // Snowflakes in front (fewer, larger)
  ctx.globalAlpha = 0.7;
  for (let i = 0; i < 15; i++) {
    const sf = game.snowflakes[i];
    ctx.fillStyle = '#fff';
    ctx.fillRect(Math.floor(sf.x), Math.floor(sf.y), sf.size + 1, sf.size + 1);
  }
  ctx.globalAlpha = 1;
}

function drawMountains() {
  const offset = (game.scrollX || 0) * 0.1;
  ctx.fillStyle = '#2a3050';
  ctx.beginPath();
  ctx.moveTo(0, GROUND_Y);
  for (let x = 0; x <= W; x += 40) {
    const h = Math.sin((x + offset) * 0.006) * 80 + Math.sin((x + offset) * 0.002) * 50 + 100;
    ctx.lineTo(x, GROUND_Y - h);
  }
  ctx.lineTo(W, GROUND_Y);
  ctx.fill();

  ctx.fillStyle = '#3a4060';
  ctx.beginPath();
  ctx.moveTo(0, GROUND_Y);
  for (let x = 0; x <= W; x += 30) {
    const h = Math.sin((x + offset * 1.5) * 0.01) * 50 + Math.sin((x + offset * 1.5) * 0.004) * 30 + 70;
    ctx.lineTo(x, GROUND_Y - h);
  }
  ctx.lineTo(W, GROUND_Y);
  ctx.fill();

  // Snow caps
  ctx.fillStyle = '#e8eaf6';
  ctx.globalAlpha = 0.3;
  ctx.beginPath();
  ctx.moveTo(0, GROUND_Y - 130);
  for (let x = 0; x <= W; x += 40) {
    const h = Math.sin((x + offset) * 0.006) * 80 + Math.sin((x + offset) * 0.002) * 50 + 100;
    if (h > 120) {
      ctx.lineTo(x, GROUND_Y - h);
      ctx.lineTo(x + 20, GROUND_Y - h + 15);
    }
  }
  ctx.fill();
  ctx.globalAlpha = 1;
}

// --- GAME LOOP ---
let loopStarted = false;
function gameLoop() {
  if (game.running) {
    game.scrollX += game.scrollSpeed;
    update();
  }
  draw();
  requestAnimationFrame(gameLoop);
}

// --- INPUT HANDLING ---
const btnLeft = document.getElementById('btn-left');
const btnJump = document.getElementById('btn-jump');
const btnRight = document.getElementById('btn-right');
const throwBtn = document.getElementById('throw-btn');

function handleTouchStart(zone) {
  return function(e) {
    e.preventDefault();
    if (zone === 'left') game.input.left = true;
    if (zone === 'right') game.input.right = true;
    if (zone === 'jump') game.input.jump = true;
  };
}

function handleTouchEnd(zone) {
  return function(e) {
    e.preventDefault();
    if (zone === 'left') game.input.left = false;
    if (zone === 'right') game.input.right = false;
  };
}

btnLeft.addEventListener('touchstart', handleTouchStart('left'), { passive: false });
btnLeft.addEventListener('touchend', handleTouchEnd('left'), { passive: false });
btnRight.addEventListener('touchstart', handleTouchStart('right'), { passive: false });
btnRight.addEventListener('touchend', handleTouchEnd('right'), { passive: false });
btnJump.addEventListener('touchstart', handleTouchStart('jump'), { passive: false });
btnJump.addEventListener('touchend', handleTouchEnd('jump'), { passive: false });

btnLeft.addEventListener('mousedown', () => game.input.left = true);
btnLeft.addEventListener('mouseup', () => game.input.left = false);
btnLeft.addEventListener('mouseleave', () => game.input.left = false);
btnRight.addEventListener('mousedown', () => game.input.right = true);
btnRight.addEventListener('mouseup', () => game.input.right = false);
btnRight.addEventListener('mouseleave', () => game.input.right = false);
btnJump.addEventListener('mousedown', () => game.input.jump = true);

throwBtn.addEventListener('touchstart', (e) => { e.preventDefault(); throwBurger(); }, { passive: false });
throwBtn.addEventListener('click', () => throwBurger());

document.addEventListener('keydown', (e) => {
  if (e.code === 'ArrowLeft') game.input.left = true;
  if (e.code === 'ArrowRight') game.input.right = true;
  if (e.code === 'Space') { e.preventDefault(); game.input.jump = true; }
  if (e.code === 'KeyF' || e.code === 'KeyX') throwBurger();
});

document.addEventListener('keyup', (e) => {
  if (e.code === 'ArrowLeft') game.input.left = false;
  if (e.code === 'ArrowRight') game.input.right = false;
});

// --- START / RESTART ---
document.getElementById('start-btn').addEventListener('click', () => {
  document.getElementById('start-screen').style.display = 'none';
  initGame();
  updateThrowBtn();
  if (!loopStarted) { loopStarted = true; gameLoop(); }
});

document.getElementById('restart-btn').addEventListener('click', () => {
  document.getElementById('gameover-screen').style.display = 'none';
  initGame();
  updateThrowBtn();
  if (!loopStarted) { loopStarted = true; gameLoop(); }
});

document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
</script>
</body>
</html>
